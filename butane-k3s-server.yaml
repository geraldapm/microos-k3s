variant: fcos
version: 1.5.0
systemd:
  units:
    - name: k3s-server.service
      enabled: true
      contents: |
        [Unit]
        Description=K3s Server Control Plane Service
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=notify
        EnvironmentFile=-/etc/default/%N
        EnvironmentFile=-/etc/sysconfig/%N
        EnvironmentFile=-/etc/systemd/system/k3s.service.env
        ExecStartPre=/bin/bash -c ' \
              while [ ! -e /usr/local/bin/k3s ]; do \
                echo "Waiting for /usr/local/bin/k3s to exists..."; \
                sleep 5; \
              done'
        ExecStart=/usr/local/bin/k3s server \
              ###CLUSTERMODE### \
              --token ###K3S_TOKEN### \
              --advertise-address ###IP_ADDRESS### \
              --node-ip ###IP_ADDRESS### \
              --cluster-cidr=###POD_CIDR### \
              --service-cidr=###SERVICE_CIDR### \
              --tls-san=###FLOATINGIP### \
              --selinux \
              --flannel-backend=vxlan
              --flannel-iface=enp1s0
        KillMode=process
        Delegate=yes
        # Having non-zero Limit*s causes performance problems due to accounting overhead
        # in the kernel. We recommend using cgroups to do container-local accounting.
        LimitNOFILE=1048576
        LimitNPROC=infinity
        LimitCORE=infinity
        TasksMax=infinity
        TimeoutStartSec=0
        Restart=always
        RestartSec=5s

        [Install]
        WantedBy=multi-user.target
